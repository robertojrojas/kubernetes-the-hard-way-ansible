---
# tasks file for tls_cert_generation

- name: Download CFSSL tool
  get_url:
    url: https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
    dest: /usr/bin/cfssl
    mode: 755

- name: Download CFSSL JSON tool
  get_url:
    url: https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 
    dest: /usr/bin/cfssljson
    mode: 755

- name: Copy CA configuration file
  copy: 
    src: ca-config.json 
    dest: /tmp/ 
    mode: 0755

- name: Copy CA certificate signing request 
  copy: 
    src: ca-csr.json 
    dest: /tmp/ 
    mode: 0755

- name: Generate a CA certificate and private key 
  command: bash -c 'cfssl gencert -initca /tmp/ca-csr.json | cfssljson -bare ca '
  args:
    chdir: /vagrant
    creates: /vagrant/ca-key.pem 

- name: Copy the admin client certificate signing request 
  copy: 
    src: admin-csr.json 
    dest: /tmp/ 
    mode: 0755

- name: Generate the admin client certificate and private key 
  command: bash -c 'cfssl gencert -ca=/vagrant/ca.pem -ca-key=/vagrant/ca-key.pem -config=/tmp/ca-config.json -profile=kubernetes /tmp/admin-csr.json | cfssljson -bare admin'
  args:
    chdir: /vagrant
    creates: /vagrant/admin-key.pem 

- name: Generate Worker Certificates
  include_tasks: generate_worker_certificate.yml
  loop:
     - "{{ k8s_w1 }}"
     - "{{ k8s_w2 }}"

- name: Copy the kube-controller-manager client certificate signing request 
  copy: 
    src: kube-controller-manager-csr.json
    dest: /tmp/ 
    mode: 0755

- name: Generate the kube-controller-manager client certificate and private key 
  command: bash -c 'cfssl gencert -ca=/vagrant/ca.pem -ca-key=/vagrant/ca-key.pem -config=/tmp/ca-config.json -profile=kubernetes /tmp/kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager'
  args:
    chdir: /vagrant
    creates: /vagrant/kube-controller-manager.pem 


- name: Copy the kube-proxy client certificate signing request 
  copy: 
    src: kube-proxy-csr.json 
    dest: /tmp/ 
    mode: 0755

- name: Generate the kube-proxy client certificate and private key 
  command: bash -c 'cfssl gencert -ca=/vagrant/ca.pem -ca-key=/vagrant/ca-key.pem -config=/tmp/ca-config.json -profile=kubernetes /tmp/kube-proxy-csr.json | cfssljson -bare kube-proxy'
  args:
    chdir: /vagrant
    creates: /vagrant/kube-proxy-key.pem 

- name: Copy the kube-scheduler client certificate signing request 
  copy: 
    src: kube-scheduler-csr.json 
    dest: /tmp/ 
    mode: 0755

- name: Generate the kube-scheduler client certificate and private key 
  command: bash -c 'cfssl gencert -ca=/vagrant/ca.pem -ca-key=/vagrant/ca-key.pem -config=/tmp/ca-config.json -profile=kubernetes /tmp/kube-scheduler-csr.json | cfssljson -bare kube-scheduler'
  args:
    chdir: /vagrant
    creates: /vagrant/kube-scheduler-key.pem 

- name: Copy the Kubernetes server certificate signing request 
  copy: 
    src: kubernetes-csr.json 
    dest: /tmp/ 
    mode: 0755

- name: Generate the Kubernetes certificate and private key 
  command: bash -c 'cfssl gencert -ca=/vagrant/ca.pem -ca-key=/vagrant/ca-key.pem -config=/tmp/ca-config.json -hostname=10.32.0.1,{{ k8s_c1_ip }},{{ k8s_c2_ip }},{{ k8s_lb_ip }},127.0.0.1,kubernetes.default -profile=kubernetes /tmp/kubernetes-csr.json | cfssljson -bare kubernetes'
  args:
    chdir: /vagrant
    creates: /vagrant/kubernetes-key.pem 

- name: Copy the Service Account Key Pair service-account-csr.json signing request 
  copy: 
    src: service-account-csr.json 
    dest: /tmp/ 
    mode: 0755

- name: Generate the Service Account Key Pair and private key 
  command: bash -c 'cfssl gencert -ca=/vagrant/ca.pem -ca-key=/vagrant/ca-key.pem -config=/tmp/ca-config.json -profile=kubernetes /tmp/service-account-csr.json | cfssljson -bare service-account'
  args:
    chdir: /vagrant
    creates: /vagrant/service-account-key.pem 

